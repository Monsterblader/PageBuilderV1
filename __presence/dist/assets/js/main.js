(function() {
  'use strict';

  angular.module('ramda', [])
    .service('R', ['$window', function($window) {
      return $window.R;
    }]);

}());

(function() {
  'use strict';

  angular.module('narvar', [

    // Core modules
    'ngSanitize',
    'ngRoute',
    'ngAnimate',
    'ngMessages',
    'ngResource',

    // Custom modules (app/modules/*)
    'ramda',

    // Template cache module generated by gulp
    'templates-app'

  ]).config(['$routeProvider', '$httpProvider', '$locationProvider',
    function($routeProvider, $httpProvider, $locationProvider) {
      $locationProvider.html5Mode(true);
      //$httpProvider.interceptors.push('FlashSvcInterceptor');

      $routeProvider.
        when('/', {
          templateUrl : '/views/pages/index',
          controller  : 'MainCtrl as mainCtrl'
        }).
        otherwise({
          redirectTo : '/'
        });

    }]);

}());

(function (angular) {
  'use strict';

  /**
   * @ngdoc function
   * @author seancannon
   * @name narvar.service.FlashSvc
   * @description
   * # FlashSvc
   * Service for flash messages
   */
  angular.module('narvar').service('FlashSvc', ['$rootScope', '$timeout',
    function ($rootScope, $timeout) {
      var svc = this;

      /**
       * Fetch any flash messages on the root scope.
       * @param key
       * @returns {*}
       */
      svc.getFlash = function (key) {
        var flash = $rootScope.flash;
        return (key) ? flash[key] : flash;
      };

      /**
       * Set the flash with new messages.
       * @param flash
       */
      svc.setFlash = function (flash) {
        var key;

        for (key in flash) {
          if (flash.hasOwnProperty(key) && Array.isArray(flash[key])) {
            $rootScope.flash[key] = flash[key].concat();
          }
        }

        // This lets us spam the flash message and have it toast every time.
        $timeout(svc.clearFlash);
      };

      /**
       * Resets the flash message object.
       * @returns {narvar.service.FlashSvc}
       */
      svc.clearFlash = function () {
        $rootScope.flash = {
          notice : [],
          error  : []
        };
        return svc;
      };

      return svc;
    }]).service('FlashSvcInterceptor', ['FlashSvc', function (FlashSvc) {
    return {
      'response' : function (res) {
        FlashSvc.setFlash(res.data.flash);
        return res;
      }
    };


  }]);
}(angular));

(function(angular) {
  'use strict';

  /**
   * @ngdoc function
   * @author seancannon
   * @name narvar.factory.locationSvc
   * @description
   * # locationSvc
   * Original: https://github.com/angular/angular.js/issues/1699#issuecomment-22511464
   *
   * Usage:
   *
   * (interception is needed for Back/Forward buttons to work)
   *
   * location.intercept($scope._url_pattern, function(matched) {
   *   * can return false to abort interception
   *   var type = matched[1]
   *   if (!type) {
   *     return;
   *   }
   *   $scope.safeApply(function() {
   *     $scope.data_type = type;
   *     $scope.params.page = 1;
   *     $scope.get_data();
   *   });
   * });
   *
   * anywhere in your controller:
   * location.skipReload().path(url);
   *
   * to replace in history stack:
   * location.skipReload().path(url).replace();
   */
  angular.module('narvar').factory('LocationSvc', [
    '$location',
    '$route',
    '$rootScope',
    function($location, $route, $rootScope) {
      var pageRoute = $route.current;

      $location.skipReload = function() {
        var unbind = $rootScope.$on('$locationChangeSuccess', function() {
          $route.current = pageRoute;
          unbind();
        });
        return $location;
      };

      if ($location.intercept) {
        throw '$location.intercept is already defined';
      }

      $location.intercept = function(urlPattern, loadUrl) {

        var parsePath = function() {
          var match = $location.path().match(urlPattern);
          if (match) {
            match.shift();
            return match;
          }
        };

        var unbind = $rootScope.$on("$locationChangeSuccess", function() {
          var matched = parsePath();
          if (!matched || loadUrl(matched) === false) {
            return unbind();
          }
          $route.current = pageRoute;
        });
      };

      return $location;
    }
  ]);
}(angular));

(function (angular) {
  'use strict';

  /**
   * @ngdoc function
   * @author seancannon
   * @name narvar.service.TrackingSvc
   * @description
   * # TrackingSvc
   * Service to handle tracking API calls and data persistence
   */
  angular.module('narvar').service('TrackingSvc', ['$resource', '$cacheFactory', 'R',
    function ($resource, $cacheFactory, R) {
      var svc = this;

      /**
       * Internal cache to store API responses.
       * @type {{data: *, ttl: number, expires: Date}}
       */
      svc.cache = {
        data    : $cacheFactory('TrackingSvc'),
        ttl     : 3600,
        expires : new Date() // Expired on init so first resource call will seed cache
      };

      svc.resources = {

        /**
         * Grab the tracking information from the server.
         * @todo this is a placeholder, remove before delivery
         */
        tracking : $resource('/api/v0.0.0/tracking', null, {
          'get' : {

            /**
             * Request method.
             * @type {String}
             */
            method : 'GET',

            /**
             * Scrub the data before sending it back to the controller.
             * @param data
             * @returns {*}
             */
            transformResponse : function (data) {
              data = JSON.parse(data);
              svc.cache.data.put('tracking', data);
              return data;
            }
          }

        }) // End tracking
      };

      return svc;
    }]);
}(angular));

(function (angular) {
  'use strict';

  /**
   * @ngdoc function
   * @author seancannon
   * @name narvar.controller.MainCtrl
   * @description
   * # MainCtrl
   * Main controller for the home page
   */
  angular.module('narvar').controller('MainCtrl', ['TrackingSvc',
    function (TrackingSvc) {

      this.trackingSvc = TrackingSvc;

    }]);

}(angular));

(function (angular) {
  'use strict';

  /**
   * @ngdoc function
   * @name narvar.controller:RootCtrl
   * @description
   * # RootCtrl
   * Root controller to handle app level failures and promise rejections
   */
  angular.module('narvar').controller('RootCtrl', ['$rootScope', '$location', '$window', 'FlashSvc',
    function ($rootScope, $location, $window, FlashSvc) {

      $rootScope.$on('$routeChangeError', function (event, current, previous, rejection) {
        // @todo Graceful failover before launch.
        $window.alert(rejection);
      });

      FlashSvc.clearFlash();

      this.$location = $location;

    }]);

}(angular));

'use strict';

/**
 * @ngdoc function
 * @author seancannon
 * @name narvar.directive.modal
 * @description
 * # modal
 * Reusable modal container
 */
angular.module('narvar').directive('modal', ['$window', '$timeout',
  function ($window, $timeout) {

    return {
      restrict    : 'E',
      scope       : {},
      templateUrl : '/partials/modal',
      link        : function (scope, element, attrs) {

        /**
         * Show the modal by setting visibleWrapper and visibleContent to true.
         * The view has ng-if on those properties.
         * @param params
         * @private
         */
        function _showModal (e, params) {

          params = params || {};

          scope.templateUrl = params.templateUrl || '/partials/404';
          scope.visibleWrapper = true;
          $timeout(function () {
            scope.visibleContent = true;
          }, 700);

          if (typeof params.callback === 'function') {
            params.callback();
          }
        }

        /**
         * Show the modal by setting visibleWrapper and visibleContent to false.
         * The view has ng-if on those properties.
         * @param params
         * @private
         */
        function _hideModal (e, params) {
          params = params || {};

          scope.visibleWrapper = false;
          scope.visibleContent = false;

          if (typeof params.callback === 'function') {
            params.callback();
          }
        }

        /**
         * View be used with ng-include in the modal partial
         * @type {String}
         */
        scope.templateUrl = '/partials/404';

        scope.$on('narvar.showModal', _showModal);
        scope.$on('narvar.hideModal', _hideModal);

        element.bind('click', function (e) {
          if (e.target.className.match('modal-wrapper')) {
            _hideModal();
          }
        });

      } // End link()
    };

  }]);

(function(angular) {
  'use strict';

  /**
   * @ngdoc function
   * @author seancannon
   * @name narvar.directive.siteHeader
   * @description
   * # siteHeader
   * Header with logo and nav
   */
  angular.module('narvar').directive('siteHeader', ['R',
    function(R) {
      return {
        restrict    : 'E',
        scope       : {},
        templateUrl : '/partials/site-header',
        link        : function(scope, element, attrs) {

        }
      };
    }]);
}(angular));

(function(angular) {
  'use strict';

  /**
   * @ngdoc function
   * @author seancannon
   * @name narvar.directive.faqWidget
   * @description
   * # faqWidget
   * Displays tracking information
   */
  angular.module('narvar').directive('faqWidget', ['R',
    function(R) {
      return {
        restrict : 'E',
        scope    : {
          type : '@'
        },
        templateUrl : 'widgets/faq/templates/faq-widget.html',
        link        : function(scope, element, attrs) {
          scope.tabs = [
            {
              title : "Frequently asked question 1?",
              body  : "Answer to frequently asked question 1. Bacon ipsum dolor amet boudin t-bone hamburger leberkas ham hock, turkey pig doner alcatra corned beef. Capicola tri-tip porchetta jerky ball tip shankle pancetta pork loin swine. Prosciutto beef ribs pig sirloin. Sirloin capicola andouille kielbasa tail. Picanha swine pastrami turkey turducken. Sirloin chicken filet mignon tongue jowl. Filet mignon beef ribs ham hock swine tenderloin bacon picanha venison flank drumstick pancetta salami cupim. Tongue andouille ham hock picanha kielbasa brisket pork chop bacon short ribs alcatra porchetta spare ribs ground round shankle. Capicola alcatra kielbasa spare ribs drumstick ribeye. Tri-tip hamburger cupim, jowl kielbasa flank andouille beef turducken pork loin. Tenderloin strip steak chicken, alcatra chuck tail jerky bresaola boudin pancetta. Kielbasa andouille t-bone, jowl turducken ball tip tongue ham kevin hamburger pig pork belly cow shankle. Porchetta turkey turducken, tail ribeye cow chuck jerky shoulder tri-tip."
            },
            {
              title : "Frequently asked question 2?",
              body  : "Answer to frequently asked question 2. Bacon ipsum dolor amet boudin t-bone hamburger leberkas ham hock, turkey pig doner alcatra corned beef. Capicola tri-tip porchetta jerky ball tip shankle pancetta pork loin swine. Prosciutto beef ribs pig sirloin. Sirloin capicola andouille kielbasa tail. Picanha swine pastrami turkey turducken. Sirloin chicken filet mignon tongue jowl. Filet mignon beef ribs ham hock swine tenderloin bacon picanha venison flank drumstick pancetta salami cupim. Tongue andouille ham hock picanha kielbasa brisket pork chop bacon short ribs alcatra porchetta spare ribs ground round shankle. Capicola alcatra kielbasa spare ribs drumstick ribeye. Tri-tip hamburger cupim, jowl kielbasa flank andouille beef turducken pork loin. Tenderloin strip steak chicken, alcatra chuck tail jerky bresaola boudin pancetta. Kielbasa andouille t-bone, jowl turducken ball tip tongue ham kevin hamburger pig pork belly cow shankle. Porchetta turkey turducken, tail ribeye cow chuck jerky shoulder tri-tip."
            },
            {
              title : "Frequently asked question 3?",
              body  : "Answer to frequently asked question 3. Bacon ipsum dolor amet boudin t-bone hamburger leberkas ham hock, turkey pig doner alcatra corned beef. Capicola tri-tip porchetta jerky ball tip shankle pancetta pork loin swine. Prosciutto beef ribs pig sirloin. Sirloin capicola andouille kielbasa tail. Picanha swine pastrami turkey turducken. Sirloin chicken filet mignon tongue jowl. Filet mignon beef ribs ham hock swine tenderloin bacon picanha venison flank drumstick pancetta salami cupim. Tongue andouille ham hock picanha kielbasa brisket pork chop bacon short ribs alcatra porchetta spare ribs ground round shankle. Capicola alcatra kielbasa spare ribs drumstick ribeye. Tri-tip hamburger cupim, jowl kielbasa flank andouille beef turducken pork loin. Tenderloin strip steak chicken, alcatra chuck tail jerky bresaola boudin pancetta. Kielbasa andouille t-bone, jowl turducken ball tip tongue ham kevin hamburger pig pork belly cow shankle. Porchetta turkey turducken, tail ribeye cow chuck jerky shoulder tri-tip."
            }
          ];
        }
      }
    }]);
}(angular));

(function(angular) {
  'use strict';

  /**
   * @ngdoc function
   * @author seancannon
   * @name narvar.directive.footerWidget
   * @description
   * # footerWidget
   * Displays tracking information
   */
  angular.module('narvar').directive('footerWidget', ['R',
    function(R) {
      return {
        restrict    : 'E',
        scope       : {},
        templateUrl : 'widgets/footer/templates/footer-widget.html',
        link        : function(scope, element, attrs) {

        }
      }
    }]);
}(angular));

(function(angular) {
  'use strict';

  /**
   * @ngdoc function
   * @author seancannon
   * @name narvar.directive.headerWidget
   * @description
   * # headerWidget
   * Displays tracking information
   */
  angular.module('narvar').directive('headerWidget', ['R',
    function(R) {
      return {
        restrict : 'E',
        scope    : {
          img   : '@',
          text  : '@',
          link  : '@',
          align : '@',
          fixed : '@'
        },
        templateUrl : 'widgets/header/templates/header-widget.html',
        link        : function(scope, element, attrs) {

        }
      }
    }]);
}(angular));

(function(angular) {
  'use strict';

  /**
   * @ngdoc function
   * @author seancannon
   * @name narvar.directive.smsWidget
   * @description
   * # smsWidget
   * Displays tracking information
   */
  angular.module('narvar').directive('smsWidget', ['R', '$location',
    function(R, $location) {
      return {
        restrict    : 'E',
        scope       : {
          retailerName      : '@',
          carrierName       : '@',
          errorMessage      : '@',
          successMessage    : '@',
          messageDelay      : '@',
          locale            : '@',
          showSuccessButton : '&',
          successCallback   : '&',
          enableCheckbox    : '&'
        },
        templateUrl : 'widgets/sms/templates/sms-widget.html',
        link        : function(scope, element, attrs) {

          var queryString = $location.search();

          console.log('qs = ', queryString);


          scope.messageDelay      = parseInt(R.defaultTo(1000, R.prop('messageDelay', scope)), 10);
          scope.locale            = R.defaultTo('us',  R.prop('locale',            scope));
          scope.showSuccessButton = R.defaultTo(false, R.prop('showSuccessButton', scope));
          scope.successCallback   = R.defaultTo(false, R.prop('successCallback',   scope));
          scope.enableCheckbox    = R.defaultTo(false, R.prop('enableCheckbox',    scope));
        }
      }
    }]);
}(angular));

(function(angular) {
  'use strict';

  /**
   * @ngdoc function
   * @author seancannon
   * @name narvar.directive.feedbackComment
   * @description
   * # feedbackComment
   * General feedback comment
   */
  angular.module('narvar').directive('feedbackComment', ['R',
    function(R) {
      return {
        restrict : 'E',
        require  : '^surveyWidget',
        scope    : {
          caption         : '@',
          placeholderText : '@'
        },
        templateUrl : 'widgets/survey/templates/feedback-comment.html',
        link        : function(scope, element, attrs, surveyWidgetCtrl) {

          /**
           * Record the value from the customer.
           * @param {Number} value
           */
          scope.record = function(value) {
            surveyWidgetCtrl.record('Comment', value);
          };

          scope.buttonHoverState = false;
          scope.buttonClass      = scope.buttonHoverState ? 'btn-primary' : 'btn-primary-outline';
        }
      }
    }]);
}(angular));

(function(angular) {
  'use strict';

  /**
   * @ngdoc function
   * @author seancannon
   * @name narvar.directive.feedbackComplete
   * @description
   * # feedbackComplete
   * General feedback complete
   */
  angular.module('narvar').directive('feedbackComplete', ['R',
    function(R) {
      return {
        restrict : 'E',
        require  : '^surveyWidget',
        scope    : {
          caption    : '@',
          subtext    : '@',
          buttonText : '@',
          buttonHref : '@'
        },
        templateUrl : 'widgets/survey/templates/feedback-complete.html',
        link        : function(scope, element, attrs, surveyWidgetCtrl) {
          scope.buttonHoverState = false;
          scope.buttonClass      = scope.buttonHoverState ? 'btn-primary' : 'btn-primary-outline';
        }
      }
    }]);
}(angular));

(function(angular) {

  'use strict';

  /**
   * @ngdoc function
   * @author seancannon
   * @name narvar.directive.feedbackStars
   * @description
   * # feedbackStars
   * Overall rating for the delivery.
   */
  angular.module('narvar').directive('feedbackStars', ['R',
    function(R) {

      var title = 'How was your delivery?';

      return {
        restrict : 'E',
        require  : '^surveyWidget',
        scope    : {
          caption    : '@',
          adjectives : '='
        },
        templateUrl : 'widgets/survey/templates/feedback-stars.html',
        link        : function(scope, element, attrs, surveyWidgetCtrl) {

          /**
           * Set the caption to one of the hovered stars adjective strings.
           * @param {Number} index
           */
          scope.setCaptionFromAdjectivesIndex = function(index) {
            scope.caption = scope.adjectives[index];
          };

          /**
           * Reset the caption to the default title.
           */
          scope.resetCaption = function() {
            scope.caption = title;
          };

          /**
           * Record the value from the customer.
           * @param {Number} value
           */
          scope.record = function(value) {
            surveyWidgetCtrl.record('Stars rating', value);
          };

          scope.hoverIndex = -1;
          scope.title      = scope.caption;
        }
      }
    }]);
}(angular));

(function(angular) {

  'use strict';

  /**
   * @ngdoc function
   * @author seancannon
   * @name narvar.directive.feedbackTiming
   * @description
   * # feedbackTiming
   * Feedback for delivery promptness.
   */
  angular.module('narvar').directive('feedbackTiming', ['R',
    function(R) {
      return {
        restrict : 'E',
        require  : '^surveyWidget',
        scope    : {
          caption    : '@',
          adjectives : '='
        },
        templateUrl : 'widgets/survey/templates/feedback-timing.html',
        link        : function(scope, element, attrs, surveyWidgetCtrl) {

          /**
           * Set the hover state of the button.
           * @param {Boolean} state
           */
          scope.setButtonHoverState = function(state) {
            scope.buttonHoverState = state;
          };

          /**
           * Record the value from the customer.
           * @param {Number} value
           */
          scope.record = function(value) {
            surveyWidgetCtrl.record('Timing rating', value);
          };

          scope.buttonHoverState = false;
          scope.buttonClass      = scope.buttonHoverState ? 'btn-primary' : 'btn-primary-outline';

        }
      }
    }]);
}(angular));

(function(angular) {
  'use strict';

  /**
   * @ngdoc function
   * @author seancannon
   * @name narvar.directive.surveyWidget
   * @description
   * # surveyWidget
   * Displays tracking information
   */
  angular.module('narvar').directive('surveyWidget', ['R',
    function(R) {
      return {
        restrict    : 'E',
        scope       : {
          steps : '@'
        },
        controller  : function() {
          this.currentStep = 1;

          this.nextStep = function() {
            this.currentStep += 1;
            return this;
          };

          this.record = function(type, value) {
            // TODO remove console log statement and POST
            console.log(type + ': ' + value);
            return this.nextStep();
          };
        },
        controllerAs : 'surveyWidgetCtrl',
        templateUrl  : 'widgets/survey/templates/survey-widget.html',
        link         : function(scope, element, attrs) {}
      }
    }]);
}(angular));

(function(angular) {
  'use strict';

  /**
   * @ngdoc function
   * @author seancannon
   * @name narvar.directive.trackingStatusWidget
   * @description
   * # trackingStatusWidget
   * Displays tracking information
   */
  angular.module('narvar').directive('trackingStatusWidget', ['R', 'TrackingSvc',
    function(R, TrackingSvc) {

      console.log('R = ', window.R);
      return {
        restrict    : 'E',
        scope       : {},
        templateUrl : 'widgets/trackingStatus/templates/tracking-status-widget.html',
        link        : function(scope, element, attrs) {
          scope.status = 'Fetching status...';
          scope.img    = '/assets/images/processing.svg';

          TrackingSvc.resources.tracking.get(function(response) {
            var status = R.path(['tracking', 'status'], response);
            scope.status = status;
            scope.img    = '/assets/images/' + R.toLower(status) + '.svg';
          });
        }
      }
    }]);
}(angular));
